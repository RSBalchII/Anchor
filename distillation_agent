import concurrent.futures
import requests
import json
import logging
import os

# --- Configuration ---
OLLAMA_URL = "http://localhost:11434/api/generate"
TIER_3_MODEL = "deepseek-r1:1.5b-qwen-distill-q8_0"

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

def run_worker_agent(task_prompt: str) -> str:
    """
    Sends a task prompt to the TIER_3_MODEL via the Ollama API.

    Args:
        task_prompt: The prompt to send to the model.

    Returns:
        The model's response as a string.
    """
    try:
        payload = {
            "model": TIER_3_MODEL,
            "prompt": task_prompt,
            "stream": False
        }
        response = requests.post(OLLAMA_URL, json=payload, timeout=300)
        response.raise_for_status()

        response_json = response.json()
        if 'response' in response_json:
            return response_json['response'].strip()
        else:
            return "Error: No 'response' field found in Ollama output."

    except requests.exceptions.RequestException as e:
        return f"Error communicating with Ollama: {e}"
    except Exception as e:
        return f"An unexpected error occurred: {e}"

class DistillationAgent:
    """
    A Tier 2 agent that orchestrates a crew of Tier 3 worker agents
    specialized in distilling and synthesizing context.
    """
    def __init__(self):
        self.blackboard_path = "distiller_blackboard.md"

    def _synthesize_results(self, raw_results: list) -> str:
        """
        Synthesizes raw results from worker agents into a cohesive summary.
        (This is a simple boilerplate for a full synthesis model.)

        Args:
            raw_results: A list of strings, where each string is a result from a worker.

        Returns:
            A single string containing the synthesized summary.
        """
        synthesis = "## Distilled Summary\n\n"
        for i, result in enumerate(raw_results):
            synthesis += f"### Worker {i+1} Distillation\n"
            synthesis += f"{result}\n\n"
        return synthesis

    def _manage_blackboard(self, new_content: str):
        """
        Appends new content to the blackboard and truncates it to a maximum size.
        """
        max_size = 5000
        
        if os.path.exists(self.blackboard_path):
            with open(self.blackboard_path, "r") as f:
                existing_content = f.read()
        else:
            existing_content = ""

        combined_content = existing_content + new_content

        if len(combined_content) > max_size:
            truncated_content = combined_content[-max_size:]
        else:
            truncated_content = combined_content
        
        with open(self.blackboard_path, "w") as f:
            f.write(truncated_content)

    def orchestrate_active_distillation(self, text_chunk: str) -> str:
        """
        Actively distills a large text chunk into a concise summary.
        This is the agent's real-time, on-demand protocol.

        Args:
            text_chunk: A large chunk of text to be summarized.

        Returns:
            A final, high-value memory chunk for the vector database.
        """
        # 1. Generate 5 prompt variations for active distillation
        task_prompts = [
            f"Given the following text, create a concise technical summary. Text: {text_chunk}",
            f"Identify the key themes and concepts in the text and summarize them. Text: {text_chunk}",
            f"Extract all named entities and technical terms from the text. Text: {text_chunk}",
            f"Condense the following text into a 5-sentence summary. Text: {text_chunk}",
            f"Re-write the following text for a long-term memory store. Text: {text_chunk}"
        ]

        # 2. Launch the worker agents in parallel
        raw_results = []
        with concurrent.futures.ThreadPoolExecutor(max_workers=5) as executor:
            future_to_prompt = {executor.submit(run_worker_agent, prompt): prompt for prompt in task_prompts}
            for future in concurrent.futures.as_completed(future_to_prompt):
                try:
                    result = future.result()
                    raw_results.append(result)
                except Exception as exc:
                    raw_results.append(f"An exception occurred: {exc}")

        # 3. Append and truncate raw results in the blackboard file
        new_blackboard_content = f"## Active Distillation: {text_chunk[:50]}...\n\n"
        for i, result in enumerate(raw_results):
            new_blackboard_content += f"### Worker {i+1} Distillation\n"
            new_blackboard_content += f"{result}\n\n"
        self._manage_blackboard(new_blackboard_content)

        # 4. Synthesize the results
        return self._synthesize_results(raw_results)

    def orchestrate_passive_synthesis(self, memory_chunks: list) -> str:
        """
        Passively scans a list of memory chunks and synthesizes new connections.
        This is the agent's background, proactive protocol.

        Args:
            memory_chunks: A list of memory chunks from the vector database.

        Returns:
            A new, synthesized chunk of memory.
        """
        # 1. Generate 5 prompt variations for passive synthesis
        memory_text = "\n---\n".join(memory_chunks)
        task_prompts = [
            f"Synthesize the following memory chunks into a new, more coherent summary. Text: {memory_text}",
            f"What are the key relationships and connections between these chunks? Text: {memory_text}",
            f"Identify any conflicting information or logical gaps in these memories. Text: {memory_text}",
            f"Generate a title and a concise summary for the following text. Text: {memory_text}",
            f"Extract any new insights or emergent patterns from this collection of memories. Text: {memory_text}"
        ]

        # 2. Launch the worker agents in parallel
        raw_results = []
        with concurrent.futures.ThreadPoolExecutor(max_workers=5) as executor:
            future_to_prompt = {executor.submit(run_worker_agent, prompt): prompt for prompt in task_prompts}
            for future in concurrent.futures.as_completed(future_to_prompt):
                try:
                    result = future.result()
                    raw_results.append(result)
                except Exception as exc:
                    raw_results.append(f"An exception occurred: {exc}")

        # 3. Append and truncate raw results in the blackboard file
        new_blackboard_content = f"## Passive Synthesis of {len(memory_chunks)} Memories\n\n"
        for i, result in enumerate(raw_results):
            new_blackboard_content += f"### Worker {i+1} Synthesis\n"
            new_blackboard_content += f"{result}\n\n"
        self._manage_blackboard(new_blackboard_content)

        # 4. Synthesize the results
        return self._synthesize_results(raw_results)

if __name__ == "__main__":
    # --- Example Usage ---
    distiller = DistillationAgent()

    # Example 1: Active Distillation of a raw text chunk
    print("--- Running Active Distillation ---")
    raw_chat_chunk = "Rob: I think the `parse_tool_call` function is failing. Sybil: I see. Let's try to fix it. Rob: I think I found a bug in the `execute_tool` function. Sybil: That's a good find. Let's check the code. Rob: Ok, it's fixed now! What's next? Sybil: Great job. Let's start the next task."
    active_summary = distiller.orchestrate_active_distillation(raw_chat_chunk)
    print("Active Distillation Summary:")
    print(active_summary)

    print("\n" + "="*50 + "\n")

    # Example 2: Passive Synthesis of existing memory chunks
    print("--- Running Passive Synthesis ---")
    existing_memories = [
        "Memory 1: The `WorkingMemoryManager` bug was fixed by changing the `phi:latest` model to `deepseek-coder-v2`. This was a manual code edit.",
        "Memory 2: The `sybil_agent.py` file was updated with a more robust argument handler to fix a `TypeError` in the `execute_tool` function.",
        "Memory 3: The `hierarchical_agent.py` boilerplate was created to define a new multi-tiered architecture for the Chimaera."
    ]
    passive_synthesis_result = distiller.orchestrate_passive_synthesis(existing_memories)
    print("Passive Synthesis Result:")
    print(passive_synthesis_result)
# Sovereign Memory Architecture (CozoDB + WASM)

**Status:** Active (Production)
**Implementation:** `tools/sovereign-db-builder.html` and `tools/model-server-chat.html`

The memory layer is a **Browser-Native Hybrid Graph-Vector Database** running entirely in WebAssembly (WASM). It consolidates the roles of the legacy Redis (Cache) and Neo4j (Graph) into a single, persistent CozoDB instance backed by IndexedDB/OPFS.

---

## 1. Core Schema (`*memory`)

The system uses a single unified relation for all ingested knowledge, serving both as the "Long Term Memory" and the source for "Context Injection".

### Datalog Definition
```datalog
:create memory {
    id: String
    =>
    timestamp: Int,         # Unix Epoch (ms) - Used for sorting/recency
    role: String,           # 'user', 'assistant', 'system'
    content: String,        # The raw text (truncated at 20KB for WASM stability)
    source: String,         # File path or 'session'
    embedding: <F32; 384>   # Vector for semantic search (all-MiniLM-L6-v2)
}
```

### Fields
*   **`id`** *(Key)*: Unique identifier. Format: `Timestamp-RandomID`.
*   **`timestamp`**: Time of creation. Critical for "Recent Memory" retrieval.
*   **`role`**: Speaker identity.
*   **`content`**: The actual knowledge or chat message.
*   **`source`**: Provenance (e.g., `logs/session-123.json` or `specs/spec.md`).
*   **`embedding`**: 384-dimensional vector generated by `transformers.js`.

---

## 2. Persistence (The "Sovereign Loop")

1.  **Write**: Data is written to CozoDB (WASM memory).
2.  **Flush**: CozoDB automatically syncs to **IndexedDB** (`coda_memory` / `cozo_store`).
3.  **Load**: On page refresh, the app probes IndexedDB and rehydrates the CozoDB instance.

> **Zero-Loss Guarantee:** If the CozoDB instance crashes or the tab is closed, data is safe in IndexedDB.

---

## 3. Retrieval Strategies

### A. Graph-R1 Recency (Default)
Retrieves the most recent context to ground the reasoning loop.
```datalog
?[timestamp, role, source, content] := 
    *memory{timestamp, role, source, content}
    :sort -timestamp
    :limit 20
```

### B. Semantic Search (Vector)
Retrieves context based on embedding similarity (Cosine distance).
```datalog
?[id, dist] := 
    *memory{id, embedding},
    vec_l2(embedding, $query_vec)
    :limit 10
```

---

## 4. Import / Export

*   **Import**: Drag & Drop `combined_memory.json` into `sovereign-db-builder.html`.
*   **Export**: The builder allows exporting the full graph (with embeddings) to JSON for backup or transfer between devices.
